/**
 * Content Script - BuscaLogo
 * 
 * Script que roda nas p√°ginas web para coletar dados
 * quando solicitado pelo background script.
 * 
 * NOTA: A coleta agora √© manual, n√£o autom√°tica.
 */

(function() {
  'use strict';
  
  // Verifica se a API Chrome est√° dispon√≠vel
  if (typeof chrome === 'undefined' || !chrome.runtime) {
    console.log('üîç BuscaLogo: API Chrome n√£o dispon√≠vel nesta p√°gina');
    return;
  }
  
  console.log('üîç BuscaLogo: Content script carregado');
  console.log('üîç BuscaLogo: URL atual:', window.location.href);
  console.log('üîç BuscaLogo: DOM ready state:', document.readyState);
  console.log('üîç BuscaLogo: Timestamp:', new Date().toISOString());
  console.log('üîç BuscaLogo: ==========================================');
  console.log('üîç BuscaLogo: INICIALIZA√á√ÉO DO CONTENT SCRIPT');
  console.log('üîç BuscaLogo: ==========================================');
  
  // Inicializa o sistema de notifica√ß√£o de captura quando o DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCaptureNotificationSystem);
  } else {
    // DOM j√° est√° pronto, inicializa com delay
    setTimeout(initCaptureNotificationSystem, 100);
  }
  
  // Injeta CSS imediatamente para garantir que os estilos estejam dispon√≠veis
  injectCaptureStyles();
  
  // For√ßa verifica√ß√£o da p√°gina ap√≥s um tempo para garantir que apare√ßa
  setTimeout(() => {
    if (window.buscalogoCaptureSystem) {
      console.log('üéØ BuscaLogo: For√ßando verifica√ß√£o da p√°gina ap√≥s delay...');
      window.buscalogoCaptureSystem.checkCurrentPage();
    }
  }, 4000);
  
  // Teste direto de comunica√ß√£o com o background script
  setTimeout(() => {
    testBackgroundCommunication();
  }, 5000);
  
  // Teste direto da verifica√ß√£o de p√°gina
  setTimeout(() => {
    testPageVerification();
  }, 7000);
  
  // Teste direto da captura de URL
  setTimeout(() => {
    testUrlCapture();
  }, 9000);
  
  // Teste direto de envio de mensagem
  setTimeout(() => {
    testDirectMessage();
  }, 11000);
  
  async function testBackgroundCommunication() {
    try {
      console.log('üß™ BuscaLogo: Testando comunica√ß√£o com background script...');
      
      if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
        const testResponse = await new Promise((resolve, reject) => {
          chrome.runtime.sendMessage({ type: 'TEST_DATABASE' }, (response) => {
            if (chrome.runtime.lastError) {
              reject(new Error(chrome.runtime.lastError.message));
            } else {
              resolve(response);
            }
          });
        });
        
        console.log('üß™ BuscaLogo: Teste de comunica√ß√£o bem-sucedido:', testResponse);
      } else {
        console.log('üß™ BuscaLogo: Chrome runtime n√£o dispon√≠vel para teste');
      }
    } catch (error) {
      console.error('üß™ BuscaLogo: Erro no teste de comunica√ß√£o:', error);
    }
  }
  
  async function testPageVerification() {
    try {
      console.log('üß™ BuscaLogo: Testando verifica√ß√£o de p√°gina...');
      console.log('üß™ BuscaLogo: window.location.href:', window.location.href);
      console.log('üß™ BuscaLogo: Tipo da URL:', typeof window.location.href);
      
      if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
        const testResponse = await new Promise((resolve, reject) => {
          const testUrl = window.location.href;
          console.log('üß™ BuscaLogo: Enviando teste com URL:', testUrl);
          
          chrome.runtime.sendMessage({ 
            type: 'CHECK_PAGE_CAPTURED', 
            data: { url: testUrl } 
          }, (response) => {
            if (chrome.runtime.lastError) {
              reject(new Error(chrome.runtime.lastError.message));
            } else {
              resolve(response);
            }
          });
        });
        
        console.log('üß™ BuscaLogo: Teste de verifica√ß√£o bem-sucedido:', testResponse);
      } else {
        console.log('üß™ BuscaLogo: Chrome runtime n√£o dispon√≠vel para teste');
      }
    } catch (error) {
      console.error('üß™ BuscaLogo: Erro no teste de verifica√ß√£o:', error);
    }
  }
  
  function testUrlCapture() {
    try {
      console.log('üß™ BuscaLogo: Testando captura de URL...');
      console.log('üß™ BuscaLogo: window.location:', window.location);
      console.log('üß™ BuscaLogo: window.location.href:', window.location.href);
      console.log('üß™ BuscaLogo: window.location.toString():', window.location.toString());
      console.log('üß™ BuscaLogo: window.location.origin:', window.location.origin);
      console.log('üß™ BuscaLogo: window.location.pathname:', window.location.pathname);
      console.log('üß™ BuscaLogo: document.URL:', document.URL);
      console.log('üß™ BuscaLogo: document.location.href:', document.location.href);
      
      // Testa diferentes formas de capturar a URL
      const urls = [
        window.location.href,
        window.location.toString(),
        document.URL,
        document.location.href,
        window.location.origin + window.location.pathname + window.location.search
      ];
      
      urls.forEach((url, index) => {
        console.log(`üß™ BuscaLogo: URL ${index}:`, url);
        console.log(`üß™ BuscaLogo: Tipo da URL ${index}:`, typeof url);
        console.log(`üß™ BuscaLogo: URL ${index} √© v√°lida:`, url && url.length > 0);
      });
      
    } catch (error) {
      console.error('üß™ BuscaLogo: Erro no teste de captura de URL:', error);
    }
  }
  
  async function testDirectMessage() {
    try {
      console.log('üß™ BuscaLogo: Testando mensagem direta...');
      
      if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
        // Teste 1: Mensagem simples
        console.log('üß™ BuscaLogo: Teste 1 - Mensagem simples');
        const testUrl = window.location.href;
        console.log('üß™ BuscaLogo: URL para teste:', testUrl);
        
        const message1 = {
          type: 'CHECK_PAGE_CAPTURED',
          data: { url: testUrl }
        };
        console.log('üß™ BuscaLogo: Mensagem 1 sendo enviada:', message1);
        
        const response1 = await new Promise((resolve, reject) => {
          chrome.runtime.sendMessage(message1, (response) => {
            if (chrome.runtime.lastError) {
              reject(new Error(chrome.runtime.lastError.message));
            } else {
              resolve(response);
            }
          });
        });
        
        console.log('üß™ BuscaLogo: Resposta 1 recebida:', response1);
        
        // Teste 2: Mensagem com estrutura diferente
        console.log('üß™ BuscaLogo: Teste 2 - Estrutura diferente');
        const message2 = {
          type: 'CHECK_PAGE_CAPTURED',
          data: testUrl
        };
        console.log('üß™ BuscaLogo: Mensagem 2 sendo enviada:', message2);
        
        const response2 = await new Promise((resolve, reject) => {
          chrome.runtime.sendMessage(message2, (response) => {
            if (chrome.runtime.lastError) {
              reject(new Error(chrome.runtime.lastError.message));
            } else {
              resolve(response);
            }
          });
        });
        
        console.log('üß™ BuscaLogo: Resposta 2 recebida:', response2);
        
      } else {
        console.log('üß™ BuscaLogo: Chrome runtime n√£o dispon√≠vel para teste');
      }
    } catch (error) {
      console.error('üß™ BuscaLogo: Erro no teste de mensagem direta:', error);
    }
  }
  
  // Debug: verifica se o content script est√° rodando
  console.log('üîç BuscaLogo: Content script carregado e inicializando...');
  console.log('üîç BuscaLogo: DOM ready state:', document.readyState);
  console.log('üîç BuscaLogo: URL atual:', window.location.href);
  

  
  // Fun√ß√£o que ser√° chamada pelo background script para coletar dados
  // Esta fun√ß√£o √© injetada via chrome.scripting.executeScript
  window.BuscaLogoCollectPageData = function() {
    try {
      const pageData = {
        meta: extractMetaData(),
        headings: extractHeadings(),
        paragraphs: extractParagraphs(),
        lists: extractLists(),
        links: extractLinks(),
        contentAnalysis: analyzeContent(),
        terms: []
      };
      pageData.terms = generateSearchTerms(pageData);
      console.log('üîç BuscaLogo: Dados da p√°gina coletados manualmente');
      return pageData;
    } catch (error) {
      console.error('‚ùå BuscaLogo: Erro ao coletar dados da p√°gina:', error);
      return null;
    }
  };
  

  
  /**
   * Injeta estilos CSS para o sistema de notifica√ß√£o
   */
  function injectCaptureStyles() {
    try {
      // Verifica se j√° foi injetado
      if (document.getElementById('buscalogo-capture-styles')) {
        return;
      }
      
      const style = document.createElement('style');
      style.id = 'buscalogo-capture-styles';
      style.textContent = `
        /* Sistema de Notifica√ß√£o Visual - BuscaLogo */
        .buscalogo-capture-notification {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 999999;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 16px 20px;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s ease;
          max-width: 320px;
          min-width: 280px;
          animation: buscalogo-slide-in 0.5s ease-out;
        }
        
        .buscalogo-capture-notification:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        
        .buscalogo-capture-notification.capturing {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          pointer-events: none;
        }
        
        .buscalogo-capture-notification.already-captured {
          background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
          pointer-events: none;
        }
        
        .buscalogo-capture-notification.hidden {
          opacity: 0;
          transform: translateX(100px);
          pointer-events: none;
        }
        
        .buscalogo-capture-content {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .buscalogo-capture-icon {
          font-size: 20px;
          flex-shrink: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 24px;
          height: 24px;
        }
        
        .buscalogo-capture-text {
          flex: 1;
          line-height: 1.4;
          min-width: 0;
        }
        
        .notification-title {
          font-weight: 600;
          font-size: 14px;
          margin-bottom: 4px;
          line-height: 1.2;
        }
        
        .notification-message {
          font-size: 12px;
          opacity: 0.9;
          line-height: 1.3;
        }
        
        .buscalogo-capture-close {
          background: rgba(255, 255, 255, 0.2);
          border: none;
          color: white;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          transition: background 0.2s ease;
          font-weight: bold;
        }
        
        .buscalogo-capture-close:hover {
          background: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes buscalogo-slide-in {
          from {
            opacity: 0;
            transform: translateX(100px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        
        @keyframes buscalogo-fade-out {
          0%, 80% { opacity: 1; transform: translateX(0); }
          100% { opacity: 0; transform: translateX(100px); }
        }
        
        .buscalogo-capture-notification.auto-hide {
          animation: buscalogo-fade-out 5s forwards;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
          .buscalogo-capture-notification {
            top: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
            min-width: auto;
            font-size: 13px;
          }
        }
      `;
      
      document.head.appendChild(style);
      console.log('üéØ BuscaLogo: Estilos CSS injetados');
      
    } catch (error) {
      console.error('‚ùå BuscaLogo: Erro ao injetar estilos:', error);
    }
  }
  
  /**
   * Inicializa o sistema de notifica√ß√£o de captura
   */
  function initCaptureNotificationSystem() {
    try {
      console.log('üéØ BuscaLogo: Iniciando initCaptureNotificationSystem...');
      
      // Verifica se j√° foi inicializado
      if (window.buscalogoCaptureSystem) {
        console.log('üéØ BuscaLogo: Sistema j√° inicializado, retornando...');
        return;
      }
      
      console.log('üéØ BuscaLogo: Criando novo sistema de notifica√ß√£o...');
      
      // Cria o sistema de notifica√ß√£o
      const captureSystem = {
        isInitialized: false,
        currentUrl: '',
        notificationElement: null,
        autoHideTimer: null,
        settings: {
          enabled: true,
          autoHide: true,
          hideDelay: 8000
        },
        
        init() {
          if (this.isInitialized) return;
          
          console.log('üéØ BuscaLogo: Inicializando sistema de captura...');
          
          // Carrega configura√ß√µes
          this.loadSettings();
          
          // Configura observador de mudan√ßas de URL
          this.setupUrlObserver();
          
          // Verifica p√°gina atual com delay para garantir que tudo esteja pronto
          setTimeout(() => {
            console.log('üéØ BuscaLogo: Verificando p√°gina atual ap√≥s inicializa√ß√£o...');
            this.checkCurrentPage();
          }, 2000);
          
          this.isInitialized = true;
          console.log('‚úÖ BuscaLogo: Sistema de captura inicializado');
          
          // Carrega configura√ß√µes de forma ass√≠ncrona depois
          this.loadSettingsAsync();
        },
        
        async loadSettingsAsync() {
          try {
            console.log('üéØ BuscaLogo: Carregando configura√ß√µes de forma ass√≠ncrona...');
            if (typeof chrome !== 'undefined' && chrome.storage) {
              const result = await chrome.storage.local.get(['floatingCaptureSettings']);
              if (result.floatingCaptureSettings) {
                this.settings = { ...this.settings, ...result.floatingCaptureSettings };
                console.log('üéØ BuscaLogo: Configura√ß√µes carregadas:', this.settings);
              }
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è BuscaLogo: Erro ao carregar configura√ß√µes ass√≠ncronas:', error);
          }
        },
        
        loadSettings() {
          try {
            console.log('üéØ BuscaLogo: Carregando configura√ß√µes...');
            // Por enquanto usa configura√ß√µes padr√£o
            // As configura√ß√µes ser√£o carregadas de forma ass√≠ncrona depois
            console.log('üéØ BuscaLogo: Configura√ß√µes padr√£o aplicadas:', this.settings);
          } catch (error) {
            console.warn('‚ö†Ô∏è BuscaLogo: Erro ao carregar configura√ß√µes, usando padr√µes');
          }
        },
        
        setupUrlObserver() {
          // Debounced para evitar m√∫ltiplas execu√ß√µes
          const debouncedCheck = () => {
            setTimeout(() => {
              this.checkCurrentPage();
            }, 300);
          };
          
          // Observa mudan√ßas na URL
          let currentUrl = window.location.href;
          const observer = new MutationObserver(() => {
            if (window.location.href !== currentUrl) {
              currentUrl = window.location.href;
              debouncedCheck();
            }
          });
          
          // Observa mudan√ßas no body (para SPAs)
          observer.observe(document.body, {
            childList: true,
            subtree: true
          });
          
          // Tamb√©m escuta eventos de navega√ß√£o
          window.addEventListener('popstate', debouncedCheck);
          window.addEventListener('pushstate', debouncedCheck);
          window.addEventListener('replacestate', debouncedCheck);
        },
        
        async checkCurrentPage() {
          console.log('üéØ BuscaLogo: checkCurrentPage chamado');
          console.log('üéØ BuscaLogo: isInitialized:', this.isInitialized);
          console.log('üéØ BuscaLogo: settings.enabled:', this.settings.enabled);
          
          if (!this.settings.enabled) {
            console.log('üéØ BuscaLogo: Sistema desabilitado, retornando...');
            return;
          }
          
          try {
            const url = window.location.href;
            console.log('üéØ BuscaLogo: Verificando URL:', url);
            console.log('üéØ BuscaLogo: Tipo da URL capturada:', typeof url);
            console.log('üéØ BuscaLogo: URL capturada √© v√°lida?', url && url.length > 0);
            
            // Verifica se a URL √© v√°lida
            if (!url || url.length === 0) {
              console.error('üéØ BuscaLogo: URL inv√°lida capturada:', url);
              return;
            }
            
            // Evita verificar a mesma URL
            if (url === this.currentUrl) {
              console.log('üéØ BuscaLogo: Mesma URL, retornando...');
              return;
            }
            this.currentUrl = url;
            
            // Verifica se √© uma p√°gina v√°lida
            if (!this.isValidPage(url)) {
              console.log('üéØ BuscaLogo: URL inv√°lida, ocultando notifica√ß√£o...');
              this.hideNotification();
              return;
            }
            
            console.log('üéØ BuscaLogo: URL v√°lida, verificando status...');
            console.log('üéØ BuscaLogo: Chamando checkPageStatus com URL:', url);
            // Verifica se j√° foi capturada
            await this.checkPageStatus(url);
            
          } catch (error) {
            console.warn('‚ö†Ô∏è BuscaLogo: Erro ao verificar p√°gina:', error);
          }
        },
        
        isValidPage(url) {
          try {
            const urlObj = new URL(url);
            return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
          } catch {
            return false;
          }
        },
        
        async checkPageStatus(url) {
          try {
            console.log('üéØ BuscaLogo: checkPageStatus chamado para URL:', url);
            console.log('üéØ BuscaLogo: Tipo da URL:', typeof url);
            console.log('üéØ BuscaLogo: URL √© v√°lida?', url && url.length > 0);
            
            // Verifica se a URL √© v√°lida
            if (!url || url.length === 0) {
              console.error('üéØ BuscaLogo: URL inv√°lida recebida:', url);
              return;
            }
            
            // Envia mensagem para verificar se j√° foi capturada
            console.log('üéØ BuscaLogo: Enviando mensagem CHECK_PAGE_CAPTURED...');
            const messageData = { url: url };
            console.log('üéØ BuscaLogo: Dados da mensagem:', messageData);
            console.log('üéØ BuscaLogo: messageData.url:', messageData.url);
            console.log('üéØ BuscaLogo: Tipo de messageData.url:', typeof messageData.url);
            console.log('üéØ BuscaLogo: messageData.url.length:', messageData.url?.length);
            const response = await this.sendMessage('CHECK_PAGE_CAPTURED', messageData);
            
            console.log('üéØ BuscaLogo: Resposta recebida:', response);
            console.log('üéØ BuscaLogo: Tipo da resposta:', typeof response);
            console.log('üéØ BuscaLogo: response.success:', response?.success);
            console.log('üéØ BuscaLogo: response.isCaptured:', response?.isCaptured);
            console.log('üéØ BuscaLogo: response.isCaptured === true?', response?.isCaptured === true);
            console.log('üéØ BuscaLogo: response.isCaptured === false?', response?.isCaptured === false);
            
            if (response && response.success) {
              if (response.isCaptured === true) {
                console.log('üéØ BuscaLogo: P√°gina j√° capturada, verificando configura√ß√£o...');
                // Verifica se deve mostrar notifica√ß√£o de p√°gina j√° capturada
                if (response.showAlreadyCaptured === true) {
                  console.log('üéØ BuscaLogo: Configura√ß√£o permite mostrar notifica√ß√£o de j√° capturada');
                  this.showAlreadyCapturedNotification();
                } else {
                  console.log('üéØ BuscaLogo: Configura√ß√£o desabilita notifica√ß√£o de j√° capturada - n√£o mostrando nada');
                }
              } else if (response.isCaptured === false) {
                console.log('üéØ BuscaLogo: P√°gina n√£o capturada, verificando configura√ß√£o...');
                // Verifica se deve mostrar notifica√ß√£o de p√°gina n√£o capturada
                if (response.showNotCaptured === true) {
                  console.log('üéØ BuscaLogo: Configura√ß√£o permite mostrar notifica√ß√£o de n√£o capturada');
                  this.showCaptureNotification();
                } else {
                  console.log('üéØ BuscaLogo: Configura√ß√£o desabilita notifica√ß√£o de n√£o capturada - n√£o mostrando nada');
                }
              } else {
                console.log('üéØ BuscaLogo: Resposta amb√≠gua, response.isCaptured =', response.isCaptured);
                console.log('üéØ BuscaLogo: Mostrando notifica√ß√£o por padr√£o...');
                this.showCaptureNotification();
              }
            } else {
              console.log('üéØ BuscaLogo: Resposta inv√°lida, response =', response);
              console.log('üéØ BuscaLogo: Mostrando notifica√ß√£o por padr√£o...');
              // Se n√£o conseguir verificar, mostra por padr√£o
              this.showCaptureNotification();
            }
            
          } catch (error) {
            console.warn('‚ö†Ô∏è BuscaLogo: Erro ao verificar status da p√°gina:', error);
            console.log('üéØ BuscaLogo: Em caso de erro, mostrando notifica√ß√£o por padr√£o...');
            // Em caso de erro, mostra a notifica√ß√£o
            this.showCaptureNotification();
          }
        },
        
        showCaptureNotification() {
          console.log('üéØ BuscaLogo: showCaptureNotification chamado');
          this.createNotification(
            'üîç P√°gina n√£o capturada',
            'Clique para adicionar ao sistema de busca',
            'capture'
          );
        },
        
        showAlreadyCapturedNotification() {
          console.log('üéØ BuscaLogo: showAlreadyCapturedNotification chamado');
          this.createNotification(
            '‚úÖ P√°gina j√° capturada',
            'Esta p√°gina j√° est√° no sistema de busca',
            'already-captured'
          );
        },
        
        createNotification(title, message, type = 'capture') {
          try {
            console.log('üéØ BuscaLogo: createNotification chamado com:', title, message, type);
            
            // Remove notifica√ß√£o existente
            this.hideNotification();
            
            // Cria elemento de notifica√ß√£o
            const notification = document.createElement('div');
            notification.className = `buscalogo-capture-notification ${type}`;
            notification.id = 'buscalogo-capture-notification';
            
            notification.innerHTML = `
              <div class="buscalogo-capture-content">
                <span class="buscalogo-capture-icon">${type === 'capture' ? 'üîç' : '‚úÖ'}</span>
                <div class="buscalogo-capture-text">
                  <div class="notification-title">${title}</div>
                  <div class="notification-message">${message}</div>
                </div>
                <button class="buscalogo-capture-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
              </div>
            `;
            
            // Adiciona event listeners
            if (type === 'capture') {
              notification.addEventListener('click', (e) => {
                if (!e.target.classList.contains('buscalogo-capture-close')) {
                  this.handleCaptureClick();
                }
              });
            }
            
            // Adiciona ao DOM
            console.log('üéØ BuscaLogo: Adicionando notifica√ß√£o ao DOM...');
            document.body.appendChild(notification);
            this.notificationElement = notification;
            
            // Auto-hide se configurado
            if (this.settings.autoHide) {
              this.startAutoHide();
            }
            
            console.log('‚úÖ BuscaLogo: Notifica√ß√£o criada e exibida com sucesso');
            
          } catch (error) {
            console.error('‚ùå BuscaLogo: Erro ao criar notifica√ß√£o:', error);
          }
        },
        
        hideNotification() {
          if (this.notificationElement && this.notificationElement.parentNode) {
            this.notificationElement.remove();
            this.notificationElement = null;
          }
          this.stopAutoHide();
        },
        
        startAutoHide() {
          this.stopAutoHide();
          
          this.autoHideTimer = setTimeout(() => {
            if (this.notificationElement && this.settings.autoHide) {
              this.notificationElement.classList.add('auto-hide');
              setTimeout(() => {
                this.hideNotification();
              }, 5000);
            }
          }, this.settings.hideDelay);
        },
        
        stopAutoHide() {
          if (this.autoHideTimer) {
            clearTimeout(this.autoHideTimer);
            this.autoHideTimer = null;
          }
        },
        
        async handleCaptureClick() {
          try {
            console.log('üéØ BuscaLogo: handleCaptureClick chamado');
            
            // Mostra estado de capturando
            this.notificationElement.classList.add('capturing');
            this.notificationElement.querySelector('.buscalogo-capture-text').innerHTML = `
              <div class="notification-title">‚è≥ Capturando...</div>
              <div class="notification-message">Aguarde um momento</div>
            `;
            
            // Envia comando de captura
            const response = await this.sendMessage('CAPTURE_CURRENT_PAGE', {
              url: window.location.href,
              title: document.title
            });
            
            if (response && response.success) {
              // Sucesso - mostra como j√° capturado
              this.notificationElement.classList.remove('capturing');
              this.showAlreadyCapturedNotification();
              
              // Notifica sucesso
              this.showSuccessMessage('‚úÖ P√°gina capturada com sucesso!');
              
            } else {
              throw new Error(response?.error || 'Erro desconhecido');
            }
            
          } catch (error) {
            console.error('‚ùå BuscaLogo: Erro ao capturar p√°gina:', error);
            
            // Restaura notifica√ß√£o
            this.showCaptureNotification();
            
            // Notifica erro
            this.showErrorMessage('‚ùå Erro ao capturar p√°gina: ' + error.message);
          }
        },
        
        showSuccessMessage(message) {
          this.showTemporaryMessage(message, 'success');
        },
        
        showErrorMessage(message) {
          this.showTemporaryMessage(message, 'error');
        },
        
        showTemporaryMessage(message, type = 'info') {
          try {
            const tempNotification = document.createElement('div');
            tempNotification.style.cssText = `
              position: fixed;
              top: 80px;
              right: 20px;
              background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)'};
              color: white;
              padding: 12px 16px;
              border-radius: 6px;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              font-size: 14px;
              z-index: 999998;
              animation: buscalogo-slide-in 0.3s ease-out;
            `;
            tempNotification.textContent = message;
            
            document.body.appendChild(tempNotification);
            
            // Remove ap√≥s 3 segundos
            setTimeout(() => {
              if (tempNotification.parentNode) {
                tempNotification.remove();
              }
            }, 3000);
            
          } catch (error) {
            console.warn('‚ö†Ô∏è BuscaLogo: Erro ao mostrar mensagem tempor√°ria:', error);
          }
        },
        
        async sendMessage(type, data = {}) {
          try {
            console.log('üéØ BuscaLogo: sendMessage chamado com tipo:', type, 'e dados:', data);
            console.log('üéØ BuscaLogo: chrome dispon√≠vel:', typeof chrome !== 'undefined');
            console.log('üéØ BuscaLogo: chrome.runtime dispon√≠vel:', typeof chrome !== 'undefined' && chrome.runtime);
            console.log('üéØ BuscaLogo: chrome.runtime.sendMessage dispon√≠vel:', typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage);
            
            return new Promise((resolve, reject) => {
              if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage) {
                console.log('üéØ BuscaLogo: Enviando mensagem para background script...');
                const message = { type, data };
                console.log('üéØ BuscaLogo: Mensagem sendo enviada:', message);
                console.log('üéØ BuscaLogo: message.type:', message.type);
                console.log('üéØ BuscaLogo: message.data:', message.data);
                console.log('üéØ BuscaLogo: message.data.url:', message.data?.url);
                
                chrome.runtime.sendMessage(message, (response) => {
                  console.log('üéØ BuscaLogo: Callback recebido, response:', response);
                  console.log('üéØ BuscaLogo: chrome.runtime.lastError:', chrome.runtime.lastError);
                  
                  if (chrome.runtime.lastError) {
                    console.error('üéØ BuscaLogo: Erro do runtime:', chrome.runtime.lastError);
                    reject(new Error(chrome.runtime.lastError.message));
                  } else {
                    console.log('üéØ BuscaLogo: Mensagem enviada com sucesso, resolvendo...');
                    resolve(response);
                  }
                });
              } else {
                console.error('üéØ BuscaLogo: Chrome runtime n√£o dispon√≠vel');
                reject(new Error('Chrome runtime n√£o dispon√≠vel'));
              }
            });
          } catch (error) {
            console.error('üéØ BuscaLogo: Erro ao enviar mensagem:', error);
            throw new Error('Erro ao enviar mensagem: ' + error.message);
          }
        }
      };
      
      // Disponibiliza globalmente
      window.buscalogoCaptureSystem = captureSystem;
      
      // Inicializa
      captureSystem.init();
      
    } catch (error) {
      console.error('‚ùå BuscaLogo: Erro ao inicializar sistema de captura:', error);
    }
  }
  
  /**
   * Extrai metadados da p√°gina
   */
  function extractMetaData() {
    const meta = {};
    
    try {
      const metaTags = document.querySelectorAll('meta');
      metaTags.forEach(tag => {
        const name = tag.getAttribute('name') || tag.getAttribute('property');
        const content = tag.getAttribute('content');
        if (name && content) {
          meta[name] = content;
        }
      });
    } catch (error) {
      console.warn('‚ö†Ô∏è BuscaLogo: Erro ao extrair metadados:', error);
    }
    
    return meta;
  }
  
  /**
   * Extrai headings (h1, h2, h3) da p√°gina
   */
  function extractHeadings() {
    const headings = [];
    
    try {
      const headingElements = document.querySelectorAll('h1, h2, h3');
      headingElements.forEach(heading => {
        const text = heading.textContent?.trim();
        if (text && text.length > 0) {
          headings.push({
            level: heading.tagName.toLowerCase(),
            text: text
          });
        }
      });
    } catch (error) {
      console.warn('‚ö†Ô∏è BuscaLogo: Erro ao extrair headings:', error);
    }
    
    return headings;
  }
  
  /**
   * Extrai par√°grafos da p√°gina
   */
  function extractParagraphs() {
    const paragraphs = [];
    
    try {
      const pElements = document.querySelectorAll('p');
      pElements.forEach(p => {
        const text = p.textContent?.trim();
        if (text && text.length > 10) { // Ignora par√°grafos muito curtos
          paragraphs.push(text);
        }
      });
    } catch (error) {
      console.warn('‚ö†Ô∏è BuscaLogo: Erro ao extrair par√°grafos:', error);
    }
    
    return paragraphs;
  }
  
  /**
   * Extrai listas da p√°gina
   */
  function extractLists() {
    const lists = [];
    
    try {
      const listElements = document.querySelectorAll('ul, ol');
      listElements.forEach(list => {
        const items = [];
        const listItems = list.querySelectorAll('li');
        
        listItems.forEach(item => {
          const text = item.textContent?.trim();
          if (text && text.length > 0) {
            items.push(text);
          }
        });
        
        if (items.length > 0) {
          lists.push({
            type: list.tagName.toLowerCase(),
            items: items
          });
        }
      });
    } catch (error) {
      console.warn('‚ö†Ô∏è BuscaLogo: Erro ao extrair listas:', error);
    }
    
    return lists;
  }
  
  /**
   * Extrai links relevantes da p√°gina
   */
  function extractLinks() {
    try {
      const links = [];
      const linkElements = document.querySelectorAll('a[href]');
      
      linkElements.forEach(link => {
        const href = link.getAttribute('href');
        const text = link.textContent?.trim();
        const title = link.getAttribute('title');
        const rel = link.getAttribute('rel');
        
        // Filtra links relevantes
        if (href && text && text.length > 0 && !isInternalNavigation(href, text)) {
          const linkData = {
            url: href,
            text: text,
            title: title || '',
            rel: rel || '',
            type: classifyLink(href, text, rel),
            relevance: calculateLinkRelevance(href, text, rel)
          };
          
          // S√≥ adiciona links com relev√¢ncia m√≠nima
          if (linkData.relevance > 0.3) {
            links.push(linkData);
          }
        }
      });
      
      // Ordena por relev√¢ncia e limita a 50 links
      links.sort((a, b) => b.relevance - a.relevance);
      return links.slice(0, 50);
      
    } catch (error) {
      console.error('‚ùå Erro ao extrair links:', error);
      return [];
    }
  }
  
  /**
   * Verifica se √© link de navega√ß√£o interna
   */
  function isInternalNavigation(href, text) {
    const internalPatterns = [
      /^#/, // √Çncoras
      /^javascript:/, // JavaScript
      /^mailto:/, // Email
      /^tel:/, // Telefone
      /^(home|in√≠cio|sobre|contato|login|cadastro|menu|navega√ß√£o)$/i, // Navega√ß√£o comum
      /^(pr√≥xima|anterior|voltar|avan√ßar|primeira|√∫ltima)$/i, // Pagina√ß√£o
      /^(gerar link|facebook|x|pinterest|e-mail|outros aplicativos)$/i, // Bot√µes sociais
      /^(postagens|arquivos|doa√ß√£o|inscreva-se|grupos)$/i // Se√ß√µes do blog
    ];
    
    return internalPatterns.some(pattern => 
      pattern.test(href) || pattern.test(text.toLowerCase())
    );
  }
  
  /**
   * Classifica o tipo de link
   */
  function classifyLink(href, text, rel) {
    const url = href.toLowerCase();
    const textLower = text.toLowerCase();
    
    // Links de not√≠cias/artigos (prioridade alta)
    if (textLower.includes('leia mais') || textLower.includes('ler mais') || 
        textLower.includes('continue lendo') || textLower.includes('saiba mais') ||
        textLower.includes('lan√ßado') || textLower.includes('lan√ßada') ||
        textLower.includes('como instalar') || textLower.includes('como fazer') ||
        textLower.includes('tutorial') || textLower.includes('dica') ||
        textLower.includes('guia') || textLower.includes('review') ||
        textLower.includes('novo') || textLower.includes('nova') ||
        textLower.includes('atualiza√ß√£o') || textLower.includes('corre√ß√£o') ||
        textLower.includes('dispon√≠vel') || textLower.includes('chegou')) {
      return 'article';
    }
    
    // Links de categoria
    if (textLower.includes('categoria') || textLower.includes('tag') || 
        textLower.includes('se√ß√£o') || textLower.includes('rubrica') ||
        textLower.includes('distro') || textLower.includes('distribui√ß√£o')) {
      return 'category';
    }
    
    // Links de autor
    if (textLower.includes('por') || textLower.includes('autor') || 
        textLower.includes('escrito por') || textLower.includes('redator') ||
        textLower.includes('lobo')) {
      return 'author';
    }
    
    // Links de data
    if (textLower.includes('data') || textLower.includes('publicado') || 
        textLower.includes('atualizado') || /\d{1,2}\/\d{1,2}\/\d{4}/.test(text) ||
        textLower.includes('setembro') || textLower.includes('mar√ßo') ||
        textLower.includes('fevereiro') || textLower.includes('janeiro')) {
      return 'date';
    }
    
    // Links externos
    if (url.startsWith('http') && !url.includes(window.location.hostname)) {
      return 'external';
    }
    
    // Links internos
    if (url.startsWith('/') || url.startsWith('./') || url.includes(window.location.hostname)) {
      return 'internal';
    }
    
    return 'general';
  }
  
  /**
   * Calcula relev√¢ncia do link
   */
  function calculateLinkRelevance(href, text, rel) {
    let relevance = 0.5; // Base
    
    // Texto mais longo = mais relevante
    if (text.length > 20) relevance += 0.2;
    if (text.length > 50) relevance += 0.1;
    
    // Tipos espec√≠ficos s√£o mais relevantes
    const type = classifyLink(href, text, rel);
    if (type === 'article') relevance += 0.4; // Aumentado para artigos
    if (type === 'category') relevance += 0.2;
    if (type === 'author') relevance += 0.2;
    
    // Links com palavras-chave espec√≠ficas s√£o mais relevantes
    const relevantKeywords = [
      'linux', 'ubuntu', 'debian', 'fedora', 'arch', 'gentoo',
      'gnome', 'kde', 'plasma', 'desktop', 'sistema',
      'instalar', 'configurar', 'tutorial', 'dica', 'guia',
      'lan√ßado', 'dispon√≠vel', 'novo', 'atualiza√ß√£o'
    ];
    
    relevantKeywords.forEach(keyword => {
      if (text.toLowerCase().includes(keyword)) {
        relevance += 0.1;
      }
    });
    
    // Links com title s√£o mais relevantes
    if (rel && rel.includes('nofollow')) relevance -= 0.1;
    
    // Links muito curtos s√£o menos relevantes
    if (text.length < 5) relevance -= 0.2;
    
    return Math.max(0, Math.min(1, relevance));
  }
  
  /**
   * Gera termos √∫nicos para busca baseados no conte√∫do da p√°gina
   */
  function generateSearchTerms(pageData) {
    try {
      // Combina todo o texto relevante
      const allText = [
        pageData.title,
        pageData.meta.description || '',
        ...pageData.headings.map(h => h.text),
        ...pageData.paragraphs,
        ...pageData.lists.flatMap(list => list.items)
      ].join(' ').toLowerCase();
      
      // Remove HTML tags e caracteres especiais
      const cleanText = allText
        .replace(/<[^>]*>/g, ' ')
        .replace(/[^\w\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      
      // Divide em palavras e filtra
      const words = cleanText.split(/\s+/)
        .filter(word => word.length > 3) // Palavras com mais de 3 caracteres
        .filter(word => !isCommonWord(word)) // Remove palavras comuns
        .filter(word => /^[a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß]+$/i.test(word)); // Apenas palavras
      
      // Remove duplicatas e limita a 50 termos
      return [...new Set(words)].slice(0, 50);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è BuscaLogo: Erro ao gerar termos de busca:', error);
      return [];
    }
  }
  
  /**
   * Verifica se uma palavra √© comum (stop words em portugu√™s)
   */
  function isCommonWord(word) {
    const commonWords = [
      'para', 'com', 'uma', 'por', 'mais', 'como', 'mas', 'foi', 'ele', 'se',
      'tem', '√†', 'seu', 'sua', 'ou', 'ser', 'quando', 'muito', 'h√°', 'nos',
      'j√°', 'est√°', 'eu', 'tamb√©m', 's√≥', 'pelo', 'pela', 'at√©', 'isso', 'ela',
      'entre', 'era', 'depois', 'sem', 'mesmo', 'aos', 'ter', 'seus', 'suas',
      'sua', 'ou', 'ser', 'quando', 'muito', 'h√°', 'nos', 'j√°', 'est√°', 'eu',
      'tamb√©m', 's√≥', 'pelo', 'pela', 'at√©', 'isso', 'ela', 'entre', 'era',
      'depois', 'sem', 'mesmo', 'aos', 'ter', 'seus', 'suas', 'sua', 'ou',
      'ser', 'quando', 'muito', 'h√°', 'nos', 'j√°', 'est√°', 'eu', 'tamb√©m',
      's√≥', 'pelo', 'pela', 'at√©', 'isso', 'ela', 'entre', 'era', 'depois'
    ];
    
    return commonWords.includes(word.toLowerCase());
  }
  
  /**
   * Analisa o conte√∫do da p√°gina para descoberta
   */
  function analyzeContent() {
    try {
      const analysis = {
        contentType: detectContentType(),
        topics: extractTopics(),
        entities: extractEntities(),
        sentiment: analyzeSentiment(),
        readingLevel: calculateReadingLevel(),
        contentStructure: analyzeContentStructure()
      };
      
      return analysis;
    } catch (error) {
      console.error('‚ùå Erro ao analisar conte√∫do:', error);
      return {};
    }
  }
  
  /**
   * Detecta o tipo de conte√∫do da p√°gina
   */
  function detectContentType() {
    const url = window.location.href.toLowerCase();
    const title = document.title.toLowerCase();
    const headings = Array.from(document.querySelectorAll('h1, h2, h3'))
      .map(h => h.textContent.toLowerCase())
      .join(' ');
    
    // Not√≠cias
    if (url.includes('/noticias/') || url.includes('/news/') || 
        title.includes('not√≠cia') || title.includes('news') ||
        headings.includes('not√≠cia') || headings.includes('news')) {
      return 'news';
    }
    
    // Artigos/Blog
    if (url.includes('/artigo/') || url.includes('/blog/') || url.includes('/post/') ||
        title.includes('artigo') || title.includes('blog') || title.includes('post')) {
      return 'article';
    }
    
    // P√°ginas de produto
    if (url.includes('/produto/') || url.includes('/product/') ||
        headings.includes('pre√ßo') || headings.includes('comprar') ||
        document.querySelector('[data-product]')) {
      return 'product';
    }
    
    // P√°ginas de categoria
    if (url.includes('/categoria/') || url.includes('/category/') ||
        headings.includes('categoria') || headings.includes('categoria')) {
      return 'category';
    }
    
    // P√°ginas institucionais
    if (url.includes('/sobre/') || url.includes('/about/') ||
        url.includes('/contato/') || url.includes('/contact/')) {
      return 'institutional';
    }
    
    return 'general';
  }
  
  /**
   * Extrai t√≥picos principais do conte√∫do
   */
  function extractTopics() {
    const topics = new Set();
    const text = document.body.textContent.toLowerCase();
    
    // T√≥picos comuns em tecnologia
    const techTopics = [
      'linux', 'ubuntu', 'debian', 'fedora', 'arch', 'gentoo',
      'programa√ß√£o', 'desenvolvimento', 'software', 'hardware',
      'intelig√™ncia artificial', 'machine learning', 'data science',
      'web development', 'mobile', 'cloud', 'devops', 'cybersecurity'
    ];
    
    techTopics.forEach(topic => {
      if (text.includes(topic.toLowerCase())) {
        topics.add(topic);
      }
    });
    
    // T√≥picos baseados em headings
    const headingTopics = Array.from(document.querySelectorAll('h1, h2, h3'))
      .map(h => h.textContent.trim())
      .filter(text => text.length > 5 && text.length < 100)
      .slice(0, 10);
    
    headingTopics.forEach(topic => topics.add(topic));
    
    return Array.from(topics);
  }
  
  /**
   * Extrai entidades nomeadas (pessoas, lugares, organiza√ß√µes)
   */
  function extractEntities() {
    const entities = {
      people: [],
      organizations: [],
      locations: [],
      products: []
    };
    
    // Extrai nomes de pessoas (padr√µes comuns)
    const peoplePatterns = [
      /\b[A-Z][a-z]+ [A-Z][a-z]+\b/g, // Nome Sobrenome
      /\b[A-Z][a-z]+ [A-Z][a-z]+ [A-Z][a-z]+\b/g // Nome Sobrenome Sobrenome
    ];
    
    peoplePatterns.forEach(pattern => {
      const matches = document.body.textContent.match(pattern);
      if (matches) {
        entities.people.push(...matches.slice(0, 10));
      }
    });
    
    // Extrai organiza√ß√µes (palavras com mai√∫sculas)
    const orgPattern = /\b[A-Z][a-z]+(?: [A-Z][a-z]+)*\b/g;
    const orgMatches = document.body.textContent.match(orgPattern);
    if (orgMatches) {
      entities.organizations = orgMatches
        .filter(org => org.length > 3 && org.length < 50)
        .slice(0, 10);
    }
    
    return entities;
  }
  
  /**
   * Analisa sentimento b√°sico do conte√∫do
   */
  function analyzeSentiment() {
    const text = document.body.textContent.toLowerCase();
    
    const positiveWords = [
      'excelente', '√≥timo', 'bom', 'positivo', 'sucesso', 'melhor',
      'inovador', 'revolucion√°rio', 'incr√≠vel', 'fant√°stico'
    ];
    
    const negativeWords = [
      'ruim', 'p√©ssimo', 'negativo', 'problema', 'erro', 'falha',
      'cr√≠tico', 'perigoso', 'prejudicial', 'terr√≠vel'
    ];
    
    let positiveCount = 0;
    let negativeCount = 0;
    
    positiveWords.forEach(word => {
      const regex = new RegExp(`\\b${word}\\b`, 'g');
      const matches = text.match(regex);
      if (matches) positiveCount += matches.length;
    });
    
    negativeWords.forEach(word => {
      const regex = new RegExp(`\\b${word}\\b`, 'g');
      const matches = text.match(regex);
      if (matches) negativeCount += matches.length;
    });
    
    if (positiveCount > negativeCount) return 'positive';
    if (negativeCount > positiveCount) return 'negative';
    return 'neutral';
  }
  
  /**
   * Calcula n√≠vel de leitura b√°sico
   */
  function calculateReadingLevel() {
    const text = document.body.textContent;
    const sentences = text.split(/[.!?]+/).length;
    const words = text.split(/\s+/).length;
    const avgWordsPerSentence = words / sentences;
    
    if (avgWordsPerSentence < 10) return 'basic';
    if (avgWordsPerSentence < 20) return 'intermediate';
    return 'advanced';
  }
  
  /**
   * Analisa estrutura do conte√∫do
   */
  function analyzeContentStructure() {
    const structure = {
      hasTableOfContents: false,
      hasRelatedArticles: false,
      hasComments: false,
      hasSocialSharing: false,
      estimatedReadingTime: 0
    };
    
    // Verifica se tem √≠ndice
    structure.hasTableOfContents = !!document.querySelector('.toc, .table-of-contents, [class*="toc"]');
    
    // Verifica se tem artigos relacionados
    structure.hasRelatedArticles = !!document.querySelector('.related, .related-articles, [class*="related"]');
    
    // Verifica se tem coment√°rios
    structure.hasComments = !!document.querySelector('.comments, .comment-section, [class*="comment"]');
    
    // Verifica se tem compartilhamento social
    structure.hasSocialSharing = !!document.querySelector('.social-share, .share-buttons, [class*="share"]');
    
    // Calcula tempo estimado de leitura
    const words = document.body.textContent.split(/\s+/).length;
    structure.estimatedReadingTime = Math.ceil(words / 200); // 200 palavras por minuto
    
    return structure;
  }
  
  // Log de inicializa√ß√£o
  console.log('üîç BuscaLogo: Content script pronto para coleta manual');
  
})();

